import trino
import pandas as pd


if __name__ == '__main__':
    print('hello, world')

    clickhouse_trino_types_dict = {
        'String': 'varchar',
        'Date': 'date',
        'Int32': 'integer',
        'Float64': 'double'
    }

    trino_clickhouse_types_dict = {
        'BOOLEAN': 'UInt8',
        'TINYINT': 'Int8',
        'SMALLINT': 'Int16',
        'INTEGER': 'Int32',
        'BIGINT': 'Int64',
        'REAL': 'Float32',
        'DOUBLE': 'Float64',
        'DECIMAL(p, s)': 'Decimal(p, s)',
        'VARCHAR': 'String',
        'CHAR': 'String',
        'VARBINARY': 'String',
        'DATE': 'Date',
        'TIMESTAMP(0)': 'DateTime',
        'UUID': 'UUID'
    }

    db_name = 'expert-system-pg'
    schema_name = 'searching'
    table_name = 'pm_4g_zdy_day'

    partition_name = 'daytime'
    primary_key = 'oid'

    sql = """
        select 
            table_catalog, 
            table_name, 
            column_name, 
            data_type
        from 
            "{}".information_schema.columns 
        where 
            table_schema = '{}' and
            table_name = '{}'
    """.format(db_name, schema_name, table_name)

    conn = trino.dbapi.connect(
        host='trino.cnio.local',
        port=80,
        user='root',
        catalog='iceberg',
        schema='cnio',
    )

    def trino_clickhouse_type_replace(trino_type: str) -> str:
        if trino_type.upper().startswith('VARCHAR'):
            return trino_clickhouse_types_dict.get('VARCHAR')
        if trino_type.upper().startswith('DECIMAL'):
            return trino_type.capitalize()
        return trino_clickhouse_types_dict.get(str(trino_type).upper())

    cur = conn.cursor()
    cur.execute(sql)
    rows = cur.fetchall()
    df = pd.DataFrame(rows)
    columns_list = pd.DataFrame()
    columns_list['column_name'] = df.iloc[:, 2]
    columns_list['type'] = df.iloc[:, 3].apply(lambda x: trino_clickhouse_type_replace(x))
    columns_list['column'] = columns_list['column_name'] + ' ' + columns_list['type']

    print(columns_list)

    columns_list_str = ",".join(columns_list['column'].values)

    df['target'] = df.iloc[:, 2] + ' ' + df.iloc[:, 3]
    columns_type_list_4trino = ','.join(df['target'].values)

    print(columns_list_str)


    create_clickhouse_sql = """
        CREATE TABLE if not exists {} (
            {}
        ) ENGINE = MergeTree()
        partition by toDateTime(substring(toString({}), 1, 8))
        ORDER BY {};
    """.format(table_name, columns_list_str, partition_name, primary_key)


    # create_clickhouse_sql = """
    #     CREATE TABLE if not exists {} (
    #         {}
    #     ) ENGINE = MergeTree()
    #     partition by  toDateTime(substring(toString({}), 1, 10))
    #     ORDER BY {};
    # """.format(table_name, columns_list_str, partition_name, primary_key)

   # print(create_clickhouse_sql)

    from clickhouse_driver import Client

    client = Client(host='10.1.77.51', port=9008, user='default', database='default', password='YJY_cu#unicom502')
    #client.execute(create_clickhouse_sql)

    insert_sql = """
         INSERT INTO "clickhouse".default.pm_4g_zdy_day
        (
            province_id,city_id,city_name,serverid,searching_datetime,sbnid,ip,oid,related_gnb,cellid,cell_name,vendor_id,network_type,kpi_0000000001,kpi_0000000008,kpi_0000000015,kpi_0000000021,kpi_0000000027,kpi_0000000028,kpi_0000000029,kpi_0000000030,kpi_0000000031,kpi_0000000032,kpi_0000000033,kpi_0000000034,kpi_0000000035,kpi_0000000036,kpi_0000000037,kpi_0000000038,kpi_0000000039,kpi_0000000040,kpi_0000000041,kpi_0000000042,kpi_0000000043,kpi_0000000044,kpi_0000000045,kpi_0000000046,kpi_0000000047,kpi_0000000047_pucch,kpi_0000000047_srs,kpi_0000000047_userspace,kpi_0000000048,kpi_0000000049,kpi_0000000050,kpi_0000000051,kpi_0000000055,kpi_0000000060,kpi_0000000061,kpi_0000000065,kpi_0000000071,kpi_0000000075,kpi_0000000081,kpi_0000000085,kpi_0000000090,kpi_0000000121,kpi_0000000122,kpi_0000000123,kpi_0000000133,kpi_0000000134,kpi_0000000138,kpi_0000000143,kpi_0000000144,kpi_0000000148,kpi_0000000153,kpi_0000000153_v,kpi_0000000154,kpi_0000000155,kpi_0000000156,kpi_0000000157,kpi_0000000158,kpi_0000000158_v,kpi_0000000159,kpi_0000000160,kpi_0000000161,kpi_0000000162,kpi_0000000163,kpi_0000000164,kpi_0000000165,kpi_0000000166,kpi_0000000167,kpi_0000000168,kpi_0000000169,kpi_0000000170,kpi_0000000171,kpi_0000000172,kpi_0000000176,kpi_0000000181,kpi_0000000181_hofailure,kpi_0000000182,kpi_0000000186,kpi_0000000191,kpi_0000000192,kpi_0000000193,kpi_0000000194,kpi_0000000195,kpi_0000000196,kpi_0000000197,kpi_0000000198,kpi_0000000199,kpi_0000000200,kpi_0000000201,kpi_0000000205,kpi_0000000210,kpi_0000000220,kpi_0000000220_rnl,kpi_0000000221,kpi_0000000222,kpi_0000000223,kpi_0000000224,kpi_0000000225,kpi_0000000226,kpi_0000000227,kpi_0000000228,kpi_0000000228_v,kpi_0000000229,kpi_0000000229_v,kpi_0000000230,kpi_0000000230_v,kpi_0000000231,kpi_0000000231_v,kpi_0000000232,kpi_0000000233,kpi_0000000237,kpi_0000000242,kpi_0000000243,kpi_0000000247,kpi_0000000252,kpi_0000000253,kpi_0000000257,kpi_0000000262,kpi_0000000263,kpi_0000000267,kpi_0000000272,kpi_0000000273,kpi_0000000274,kpi_0000000275,kpi_0000000276,kpi_0000000277,kpi_0000000278,kpi_0000000279,kpi_0000000280,kpi_0000000281,kpi_0000000282,kpi_0000000283,kpi_0000000284,kpi_0000000285,kpi_0000000286,kpi_0000000287,kpi_0000000288,kpi_0000000289,kpi_0000000290,kpi_0000000291,kpi_0000000292,kpi_0000000293,kpi_0000000294,kpi_0000000295,kpi_0000000296,kpi_0000000297,kpi_0000000298,kpi_0000000299,kpi_0000000300,kpi_0000000301,kpi_0000000302,kpi_0000000303,kpi_0000000304,kpi_0000000305,kpi_0000000306,kpi_0000000307,kpi_0000000308,kpi_0000000309,kpi_0000000310,kpi_0000000311,kpi_0000000312,kpi_0000000313,kpi_0000000314,kpi_0000000315,kpi_0000000316,kpi_0000000317,kpi_0000000318,kpi_0000000319,kpi_0000000320,kpi_0000000321,kpi_0000000322,kpi_0000000323,kpi_0000000324,kpi_0000000325,kpi_0000000326,kpi_0000000327,kpi_0000000328,kpi_0000000329,kpi_0000000330,kpi_0000000331,kpi_0000000332,kpi_0000000336,kpi_0000000342,kpi_0000000346,kpi_0000000352,kpi_0000000356,kpi_0000000362,kpi_0000000366,kpi_0000000372,kpi_0000000376,kpi_0000000381,kpi_0000000383,kpi_0000000385,kpi_0000000386,kpi_0000000390,kpi_0000000395,kpi_0000000395_1,kpi_0000000395_5,kpi_0000000396,kpi_0000000396_1,kpi_0000000396_5,kpi_0000000397,kpi_0000000401,kpi_0000000406,kpi_0000000406_1,kpi_0000000406_5,kpi_0000000475,kpi_0000000476,kpi_0000000477,kpi_0000000480,kpi_0000000483,kpi_0000000486,kpi_0000000487,kpi_0000000490,kpi_0000000493,kpi_0000000496,kpi_0000000497,kpi_0000000498,kpi_0000000508,kpi_0000000518,kpi_0000000518_1,kpi_0000000518_5,kpi_0000000519,kpi_0000000522,kpi_0000000523,kpi_0000000524,kpi_0000000543,kpi_0000000543_1,kpi_0000000543_5,kpi_0000000544,kpi_0000000545,kpi_0000000546,kpi_0000000547,kpi_0000000547_1,kpi_0000000547_5,kpi_0000000551,kpi_0000000551_k,kpi_0000000552,kpi_0000000553,kpi_0000000554,kpi_0000000555,kpi_0000000556,kpi_0000000557,kpi_0000000558,kpi_0000000559,kpi_0000000560,kpi_0000000577,kpi_0000000578,kpi_0000000579,kpi_0000000582,kpi_0000000583,kpi_0000000584,kpi_0000000585,kpi_0000000585_k,kpi_0000000586,kpi_0000000587,kpi_0000000588,kpi_0000000589,kpi_0000000590,kpi_0000000591,kpi_0000000592,kpi_0000000595,kpi_0000000596,kpi_0000000597,kpi_0000000598,kpi_0000000599,kpi_0000000600,kpi_0000000601,kpi_0000000602,kpi_0000000603,kpi_0000000604,kpi_0000000605,kpi_0000000606,kpi_0000000607,kpi_0000000608,kpi_0000000609,kpi_0000000610,kpi_0000000611,kpi_0000000612,kpi_0000000613,kpi_0000000614,kpi_0000000615,kpi_0000000616,kpi_0000000617,kpi_0000000617_cu,kpi_0000000617_du,kpi_0000000617_uu,kpi_0000000618,kpi_0000000619,kpi_0000000620,kpi_0000000623,kpi_0000000624,kpi_0000000625,kpi_0000000625_m,kpi_0000000625_s,kpi_0000000626,kpi_0000000627,kpi_0000000628,kpi_0000000629,kpi_0000000630,kpi_0000000631,kpi_0000000652,kpi_0000000653,kpi_0000000654,kpi_0000000655,kpi_0000000684,kpi_0000000685,kpi_0000000686,kpi_0000000687,pusch_mcsge11_ratio,pdsch_mcsge11_ratio,cqig7_ratio,kpi_0000000422,kpi_0000000423,kpi_0000000424,kpi_0000000425,kpi_0000000426,kpi_0000000427,kpi_0000000428,kpi_0000000429,kpi_0000000430,kpi_0000000431,kpi_0000000432,kpi_0000000433,kpi_0000000434,kpi_0000000435,kpi_0000000436,kpi_0000000437,kpi_0000000438,kpi_0000000439,kpi_0000000440,kpi_0000000441,kpi_0000000442,kpi_0000000454,kpi_0000000455,kpi_0000000456,kpi_0000000457,kpi_0000000458,kpi_0000000459,kpi_0000000460,kpi_0000000461,kpi_0000000462,kpi_0000000463,kpi_0000000464,kpi_0000000465,kpi_0000000466,kpi_0000000467,kpi_0000000468,kpi_0000000469,kpi_0000000470,kpi_0000000471,kpi_0000000472,kpi_0000000473,kpi_0000000474,kpi_0000000643,kpi_0000000644,kpi_0000000645,kpi_0000000646,kpi_0000000647,kpi_0000000648,kpi_0000000649,kpi_0000000650,kpi_0000000651
        )
        select province_id,city_id,city_name,serverid,to_date(concat(substring(cast(daytime as varchar), 1,4), '-', substring(cast(daytime as varchar), 5,2), '-', substring(cast(daytime as varchar),7,2) ),'yyyy-mm-dd'),sbnid,ip,oid,related_gnb,cellid,cell_name,vendor_id,network_type,kpi_0000000001,kpi_0000000008,kpi_0000000015,kpi_0000000021,kpi_0000000027,kpi_0000000028,kpi_0000000029,kpi_0000000030,kpi_0000000031,kpi_0000000032,kpi_0000000033,kpi_0000000034,kpi_0000000035,kpi_0000000036,kpi_0000000037,kpi_0000000038,kpi_0000000039,kpi_0000000040,kpi_0000000041,kpi_0000000042,kpi_0000000043,kpi_0000000044,kpi_0000000045,kpi_0000000046,kpi_0000000047,kpi_0000000047_pucch,kpi_0000000047_srs,kpi_0000000047_userspace,kpi_0000000048,kpi_0000000049,kpi_0000000050,kpi_0000000051,kpi_0000000055,kpi_0000000060,kpi_0000000061,kpi_0000000065,kpi_0000000071,kpi_0000000075,kpi_0000000081,kpi_0000000085,kpi_0000000090,kpi_0000000121,kpi_0000000122,kpi_0000000123,kpi_0000000133,kpi_0000000134,kpi_0000000138,kpi_0000000143,kpi_0000000144,kpi_0000000148,kpi_0000000153,kpi_0000000153_v,kpi_0000000154,kpi_0000000155,kpi_0000000156,kpi_0000000157,kpi_0000000158,kpi_0000000158_v,kpi_0000000159,kpi_0000000160,kpi_0000000161,kpi_0000000162,kpi_0000000163,kpi_0000000164,kpi_0000000165,kpi_0000000166,kpi_0000000167,kpi_0000000168,kpi_0000000169,kpi_0000000170,kpi_0000000171,kpi_0000000172,kpi_0000000176,kpi_0000000181,kpi_0000000181_hofailure,kpi_0000000182,kpi_0000000186,kpi_0000000191,kpi_0000000192,kpi_0000000193,kpi_0000000194,kpi_0000000195,kpi_0000000196,kpi_0000000197,kpi_0000000198,kpi_0000000199,kpi_0000000200,kpi_0000000201,kpi_0000000205,kpi_0000000210,kpi_0000000220,kpi_0000000220_rnl,kpi_0000000221,kpi_0000000222,kpi_0000000223,kpi_0000000224,kpi_0000000225,kpi_0000000226,kpi_0000000227,kpi_0000000228,kpi_0000000228_v,kpi_0000000229,kpi_0000000229_v,kpi_0000000230,kpi_0000000230_v,kpi_0000000231,kpi_0000000231_v,kpi_0000000232,kpi_0000000233,kpi_0000000237,kpi_0000000242,kpi_0000000243,kpi_0000000247,kpi_0000000252,kpi_0000000253,kpi_0000000257,kpi_0000000262,kpi_0000000263,kpi_0000000267,kpi_0000000272,kpi_0000000273,kpi_0000000274,kpi_0000000275,kpi_0000000276,kpi_0000000277,kpi_0000000278,kpi_0000000279,kpi_0000000280,kpi_0000000281,kpi_0000000282,kpi_0000000283,kpi_0000000284,kpi_0000000285,kpi_0000000286,kpi_0000000287,kpi_0000000288,kpi_0000000289,kpi_0000000290,kpi_0000000291,kpi_0000000292,kpi_0000000293,kpi_0000000294,kpi_0000000295,kpi_0000000296,kpi_0000000297,kpi_0000000298,kpi_0000000299,kpi_0000000300,kpi_0000000301,kpi_0000000302,kpi_0000000303,kpi_0000000304,kpi_0000000305,kpi_0000000306,kpi_0000000307,kpi_0000000308,kpi_0000000309,kpi_0000000310,kpi_0000000311,kpi_0000000312,kpi_0000000313,kpi_0000000314,kpi_0000000315,kpi_0000000316,kpi_0000000317,kpi_0000000318,kpi_0000000319,kpi_0000000320,kpi_0000000321,kpi_0000000322,kpi_0000000323,kpi_0000000324,kpi_0000000325,kpi_0000000326,kpi_0000000327,kpi_0000000328,kpi_0000000329,kpi_0000000330,kpi_0000000331,kpi_0000000332,kpi_0000000336,kpi_0000000342,kpi_0000000346,kpi_0000000352,kpi_0000000356,kpi_0000000362,kpi_0000000366,kpi_0000000372,kpi_0000000376,kpi_0000000381,kpi_0000000383,kpi_0000000385,kpi_0000000386,kpi_0000000390,kpi_0000000395,kpi_0000000395_1,kpi_0000000395_5,kpi_0000000396,kpi_0000000396_1,kpi_0000000396_5,kpi_0000000397,kpi_0000000401,kpi_0000000406,kpi_0000000406_1,kpi_0000000406_5,kpi_0000000475,kpi_0000000476,kpi_0000000477,kpi_0000000480,kpi_0000000483,kpi_0000000486,kpi_0000000487,kpi_0000000490,kpi_0000000493,kpi_0000000496,kpi_0000000497,kpi_0000000498,kpi_0000000508,kpi_0000000518,kpi_0000000518_1,kpi_0000000518_5,kpi_0000000519,kpi_0000000522,kpi_0000000523,kpi_0000000524,kpi_0000000543,kpi_0000000543_1,kpi_0000000543_5,kpi_0000000544,kpi_0000000545,kpi_0000000546,kpi_0000000547,kpi_0000000547_1,kpi_0000000547_5,kpi_0000000551,kpi_0000000551_k,kpi_0000000552,kpi_0000000553,kpi_0000000554,kpi_0000000555,kpi_0000000556,kpi_0000000557,kpi_0000000558,kpi_0000000559,kpi_0000000560,kpi_0000000577,kpi_0000000578,kpi_0000000579,kpi_0000000582,kpi_0000000583,kpi_0000000584,kpi_0000000585,kpi_0000000585_k,kpi_0000000586,kpi_0000000587,kpi_0000000588,kpi_0000000589,kpi_0000000590,kpi_0000000591,kpi_0000000592,kpi_0000000595,kpi_0000000596,kpi_0000000597,kpi_0000000598,kpi_0000000599,kpi_0000000600,kpi_0000000601,kpi_0000000602,kpi_0000000603,kpi_0000000604,kpi_0000000605,kpi_0000000606,kpi_0000000607,kpi_0000000608,kpi_0000000609,kpi_0000000610,kpi_0000000611,kpi_0000000612,kpi_0000000613,kpi_0000000614,kpi_0000000615,kpi_0000000616,kpi_0000000617,kpi_0000000617_cu,kpi_0000000617_du,kpi_0000000617_uu,kpi_0000000618,kpi_0000000619,kpi_0000000620,kpi_0000000623,kpi_0000000624,kpi_0000000625,kpi_0000000625_m,kpi_0000000625_s,kpi_0000000626,kpi_0000000627,kpi_0000000628,kpi_0000000629,kpi_0000000630,kpi_0000000631,kpi_0000000652,kpi_0000000653,kpi_0000000654,kpi_0000000655,kpi_0000000684,kpi_0000000685,kpi_0000000686,kpi_0000000687,pusch_mcsge11_ratio,pdsch_mcsge11_ratio,cqig7_ratio,kpi_0000000422,kpi_0000000423,kpi_0000000424,kpi_0000000425,kpi_0000000426,kpi_0000000427,kpi_0000000428,kpi_0000000429,kpi_0000000430,kpi_0000000431,kpi_0000000432,kpi_0000000433,kpi_0000000434,kpi_0000000435,kpi_0000000436,kpi_0000000437,kpi_0000000438,kpi_0000000439,kpi_0000000440,kpi_0000000441,kpi_0000000442,kpi_0000000454,kpi_0000000455,kpi_0000000456,kpi_0000000457,kpi_0000000458,kpi_0000000459,kpi_0000000460,kpi_0000000461,kpi_0000000462,kpi_0000000463,kpi_0000000464,kpi_0000000465,kpi_0000000466,kpi_0000000467,kpi_0000000468,kpi_0000000469,kpi_0000000470,kpi_0000000471,kpi_0000000472,kpi_0000000473,kpi_0000000474,kpi_0000000643,kpi_0000000644,kpi_0000000645,kpi_0000000646,kpi_0000000647,kpi_0000000648,kpi_0000000649,kpi_0000000650,kpi_0000000651 from "expert-system-pg".searching.pm_4g_zdy_day
    """

    print(insert_sql)

    cur = conn.cursor()
    cur.execute(insert_sql)
    rows = cur.fetchall()
    df = pd.DataFrame(rows)
    print(df)
